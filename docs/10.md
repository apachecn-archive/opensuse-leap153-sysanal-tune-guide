# 10 自动非一致性内存访问(NUMA)平衡

> 原文：<https://doc.opensuse.org/documentation/leap/tuning/html/book-tuning/cha-tuning-numactl.html>

Applies to openSUSE Leap 15.3

###### 摘要

当需要许多 CPU 和大量内存时，会遇到硬件的物理限制。在本章中，重要的限制是 CPU 和存储器之间的通信带宽有限。为解决这一问题而引入的一种架构改进是非统一内存访问(NUMA)。

在这种配置中，有多个节点。每个节点都包含所有 CPU 和内存的子集。对主内存的访问速度是由内存相对于 CPU 的位置决定的。工作负载的性能取决于应用程序线程对执行线程的 CPU 本地数据的访问。自动 NUMA 平衡按需将数据迁移到访问该数据的 CPU 本地的内存节点。根据工作负载，在使用 NUMA 硬件时，这可以显著提高性能。

[10.1 实现](cha-tuning-numactl.html#sec-tuning-numactl-implementation)

[10.2 配置](cha-tuning-numactl.html#sec-tuning-numactl-configuration)

[10.3 监控](cha-tuning-numactl.html#sec-tuning-numactl-monitoring)

[10.4 影响](cha-tuning-numactl.html#sec-tuning-numactl-impact)

## 10.1 实现

自动 NUMA 平衡分三个基本步骤进行:

1.  任务扫描器周期性地扫描任务地址空间的一部分，并标记存储器，以在下次访问数据时强制页面错误。

2.  下一次访问数据将导致 NUMA 提示错误。基于该故障，数据可以被迁移到与访问存储器的任务相关联的存储器节点。

3.  为了将一个任务、它正在使用的 CPU 和它正在访问的内存放在一起，调度程序将共享数据的任务分组。

数据的取消映射和页面错误处理会导致开销。然而，通常开销会被访问与 CPU 相关联的数据的线程所抵消。

## 10.2 配置

一段时间以来，静态配置一直是在 NUMA 硬件上调优工作负载的推荐方式。为此，可以使用`numactl`、`taskset`或`cpusets`设置内存策略。支持 NUMA 的应用程序可以使用特殊的 API。在已经创建静态策略的情况下，应该禁用自动 NUMA 平衡，因为数据访问应该已经是本地的。

`numactl` `--hardware`会显示机器的内存配置以及是否支持 NUMA。这是一台 4 节点机器的输出示例。

```sh
> numactl --hardware
available: 4 nodes (0-3)
node 0 cpus: 0 4 8 12 16 20 24 28 32 36 40 44
node 0 size: 16068 MB
node 0 free: 15909 MB
node 1 cpus: 1 5 9 13 17 21 25 29 33 37 41 45
node 1 size: 16157 MB
node 1 free: 15948 MB
node 2 cpus: 2 6 10 14 18 22 26 30 34 38 42 46
node 2 size: 16157 MB
node 2 free: 15981 MB
node 3 cpus: 3 7 11 15 19 23 27 31 35 39 43 47
node 3 size: 16157 MB
node 3 free: 16028 MB
node distances:
node   0   1   2   3
  0:  10  20  20  20
  1:  20  10  20  20
  2:  20  20  10  20
  3:  20  20  20  10
```

通过将`1`或`0`写入`/proc/sys/kernel/numa_balancing`，可以启用或禁用当前会话的自动 NUMA 平衡功能，这将分别启用或禁用该功能。要永久启用或禁用它，使用内核命令行选项`numa_balancing=[enable|disable]`。

如果启用了自动 NUMA 平衡，则可以配置任务扫描器行为。任务扫描程序平衡了自动 NUMA 平衡的开销和识别最佳数据位置所需的时间。

`numa_balancing_scan_delay_ms`

在扫描数据之前，线程必须消耗的 CPU 时间。这可以防止因进程寿命短而产生开销。

`numa_balancing_scan_period_min_ms` and `numa_balancing_scan_period_max_ms`

控制扫描任务数据的频率。根据故障的位置，扫描速率会增加或减少。这些设置控制最小和最大扫描速率。

`numa_balancing_scan_size_mb`

控制当任务扫描器处于活动状态时扫描多少地址空间。

## 10.3 监控

最重要的任务是为您的工作负载分配指标，并在启用和禁用自动 NUMA 平衡的情况下测量性能，以测量影响。如果 CPU 支持本地和远程内存访问，可以使用分析工具来监控这种监控。自动 NUMA 平衡活动可通过`/proc/vmstat`中的以下参数进行监控:

`numa_pte_updates`

被标记为 NUMA 提示错误的基页数。

`numa_huge_pte_updates`

大量透明的巨大页面被标记为 NUMA 暗示错误。结合`numa_pte_updates`可以计算出被标记的总地址空间。

`numa_hint_faults`

记录有多少 NUMA 暗示断层被捕获。

`numa_hint_faults_local`

显示有多少提示错误是针对本地节点的。结合`numa_hint_faults`，可以计算本地故障与远程故障的百分比。高百分比的本地提示错误表明工作负载接近收敛。

`numa_pages_migrated`

记录由于放错位置而被迁移的页面数量。由于迁移是一种拷贝操作，因此它是 NUMA 平衡所产生开销的最大部分。

## 10.4 影响

下面展示了一个简单的测试用例，它是一台运行 SpecJBB 2005 的 4 节点 NUMA 机器，使用一个 JVM 实例，没有围绕内存策略进行静态调优。但是，请注意，对每个工作负载的影响会有所不同，并且此示例基于预发布版本的 openSUSE Leap 12。

```sh
            Balancing disabled      Balancing enabled
TPut 1      26629.00 (  0.00%)     26507.00 ( -0.46%)
TPut 2      55841.00 (  0.00%)     53592.00 ( -4.03%)
TPut 3      86078.00 (  0.00%)     86443.00 (  0.42%)
TPut 4     116764.00 (  0.00%)    113272.00 ( -2.99%)
TPut 5     143916.00 (  0.00%)    141581.00 ( -1.62%)
TPut 6     166854.00 (  0.00%)    166706.00 ( -0.09%)
TPut 7     195992.00 (  0.00%)    192481.00 ( -1.79%)
TPut 8     222045.00 (  0.00%)    227143.00 (  2.30%)
TPut 9     248872.00 (  0.00%)    250123.00 (  0.50%)
TPut 10    270934.00 (  0.00%)    279314.00 (  3.09%)
TPut 11    297217.00 (  0.00%)    301878.00 (  1.57%)
TPut 12    311021.00 (  0.00%)    326048.00 (  4.83%)
TPut 13    324145.00 (  0.00%)    346855.00 (  7.01%)
TPut 14    345973.00 (  0.00%)    378741.00 (  9.47%)
TPut 15    354199.00 (  0.00%)    394268.00 ( 11.31%)
TPut 16    378016.00 (  0.00%)    426782.00 ( 12.90%)
TPut 17    392553.00 (  0.00%)    437772.00 ( 11.52%)
TPut 18    396630.00 (  0.00%)    456715.00 ( 15.15%)
TPut 19    399114.00 (  0.00%)    484020.00 ( 21.27%)
TPut 20    413907.00 (  0.00%)    493618.00 ( 19.26%)
TPut 21    413173.00 (  0.00%)    510386.00 ( 23.53%)
TPut 22    420256.00 (  0.00%)    521016.00 ( 23.98%)
TPut 23    425581.00 (  0.00%)    536214.00 ( 26.00%)
TPut 24    429052.00 (  0.00%)    532469.00 ( 24.10%)
TPut 25    426127.00 (  0.00%)    526548.00 ( 23.57%)
TPut 26    422428.00 (  0.00%)    531994.00 ( 25.94%)
TPut 27    424378.00 (  0.00%)    488340.00 ( 15.07%)
TPut 28    419338.00 (  0.00%)    543016.00 ( 29.49%)
TPut 29    403347.00 (  0.00%)    529178.00 ( 31.20%)
TPut 30    408681.00 (  0.00%)    510621.00 ( 24.94%)
TPut 31    406496.00 (  0.00%)    499781.00 ( 22.95%)
TPut 32    404931.00 (  0.00%)    502313.00 ( 24.05%)
TPut 33    397353.00 (  0.00%)    522418.00 ( 31.47%)
TPut 34    382271.00 (  0.00%)    491989.00 ( 28.70%)
TPut 35    388965.00 (  0.00%)    493012.00 ( 26.75%)
TPut 36    374702.00 (  0.00%)    502677.00 ( 34.15%)
TPut 37    367578.00 (  0.00%)    500588.00 ( 36.19%)
TPut 38    367121.00 (  0.00%)    496977.00 ( 35.37%)
TPut 39    355956.00 (  0.00%)    489430.00 ( 37.50%)
TPut 40    350855.00 (  0.00%)    487802.00 ( 39.03%)
TPut 41    345001.00 (  0.00%)    468021.00 ( 35.66%)
TPut 42    336177.00 (  0.00%)    462260.00 ( 37.50%)
TPut 43    329169.00 (  0.00%)    467906.00 ( 42.15%)
TPut 44    329475.00 (  0.00%)    470784.00 ( 42.89%)
TPut 45    323845.00 (  0.00%)    450739.00 ( 39.18%)
TPut 46    323878.00 (  0.00%)    435457.00 ( 34.45%)
TPut 47    310524.00 (  0.00%)    403914.00 ( 30.07%)
TPut 48    311843.00 (  0.00%)    459017.00 ( 47.19%)

                        Balancing Disabled        Balancing Enabled
 Expctd Warehouse          48.00 (  0.00%)          48.00 (  0.00%)
 Expctd Peak Bops      310524.00 (  0.00%)      403914.00 ( 30.07%)
 Actual Warehouse          25.00 (  0.00%)          29.00 ( 16.00%)
 Actual Peak Bops      429052.00 (  0.00%)      543016.00 ( 26.56%)
 SpecJBB Bops            6364.00 (  0.00%)        9368.00 ( 47.20%)
 SpecJBB Bops/JVM        6364.00 (  0.00%)        9368.00 ( 47.20%)
```

自动 NUMA 平衡简化了 NUMA 机器上的高性能工作负载调优。在可能的情况下，仍然建议静态调整工作负载，以便在每个节点内对其进行分区。然而，在所有其他情况下，自动 NUMA 平衡应该会提高性能。
